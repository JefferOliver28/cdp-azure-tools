{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "metadata": {
        "description": "List of available Azure regions to choose from 'westus,eastus,northeurope,westeurope,eastasia,southeastasia,northcentralus,southcentralus,centralus,eastus2,japaneast,japanwest,brazilsouth,australiaeast,australiasoutheast,centralindia,southindia,westindia,canadacentral,canadaeast,westcentralus,westus2,ukwest,uksouth,koreacentral,koreasouth,francecentral,australiacentral,southafricanorth,uaenorth'."
      }
    },
    "assumerIdentityRAName1": {
      "defaultValue": "[newGuid()]",
      "type": "string",
      "metadata": {
        "description": "Name for the one of the assumer identity role assignment. It can be any GUID. Leave it as [newGuid()] to generate a new GUID."
      }
    },
    "assumerIdentityRAName2": {
      "defaultValue": "[newGuid()]",
      "type": "string",
      "metadata": {
        "description": "Name for the one of the assumer identity role assignment. It can be any GUID. Leave it as [newGuid()] to generate a new GUID."
      }
    },
    "assumerIdentityName": {
      "defaultValue": "cdppocAssumerIdentity",
      "type": "string",
      "metadata": {
        "description": "Name of Azure Managed Identity that VM will assume."
      }
    }
  },
  "variables": {
    "MIO": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', 'f1a07417-d97a-45cb-824c-7a7467783830')]",
    "VMC": "[concat('/subscriptions/',subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', '9980e02c-c2be-4d73-94e8-173b1dc7cf3c')]"
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2018-11-30",
      "name": "[parameters('assumerIdentityName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2018-09-01-preview",
      "name": "[parameters('assumerIdentityRAName1')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[parameters('assumerIdentityName')]"
      ],
      "properties": {
        "roleDefinitionId": "[variables('VMC')]",
        "scope": "[subscription().id]",
        "principalId": "[reference(parameters('assumerIdentityName')).principalId]"
      }
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2018-09-01-preview",
      "name": "[parameters('assumerIdentityRAName2')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[parameters('assumerIdentityName')]"
      ],
      "properties": {
        "roleDefinitionId": "[variables('MIO')]",
        "scope": "[subscription().id]",
        "principalId": "[reference(parameters('assumerIdentityName')).principalId]"
      }
    }
  ]
}